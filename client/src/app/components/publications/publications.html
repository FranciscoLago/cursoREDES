<div class="publications">
    @if (status === 'error') {
    <div class="form-alert form-alert-error">
        No se pudieron cargar las publicaciones. Intentalo de nuevo.
    </div>
    }

    @if (publications.length === 0 && status !== 'error') {
    <div class="form-alert">
        No hay publicaciones para mostrar.
    </div>
    }

    @for (publication of publications; track $index) {
    <div class="publication-card">
        <div class="publication-header">
            <div class="publication-avatar">
                @if (publication.user.image) {
                <a [routerLink]="['/perfil', publication.user._id]" class="user-link">
                    <img src="{{url + 'get-image-user/' + publication.user.image}}" alt="{{publication.user.name}}">
                </a>
                }
                @if (!publication.user.image) {
                <a [routerLink]="['/perfil', publication.user._id]" class="publication-fallback user-link">
                    {{publication.user.name.charAt(0)}}{{publication.user.surname.charAt(0)}}
                </a>
                }
            </div>
            <div class="publication-user-info">
                <a [routerLink]="['/perfil', publication.user._id]" class="user-link">
                    <h4 class="publication-user">{{publication.user.name}} {{publication.user.surname}}</h4>
                </a>
                <p class="publication-date" [title]="publication.created_at | date:'dd/MM/yyyy, HH:mm'">
                    {{publication.created_at | timeAgo}}
                </p>
            </div>
            @if (publication.user._id === identity._id) {
            <button class="publication-delete-btn" (click)="openDeleteModal(publication._id)"
                title="Eliminar publicaci√≥n">
                <span class="bi bi-trash"></span>
            </button>
            }
        </div>
        <div class="publication-content">
            <p>{{publication.text}}</p>
            @if (publication.file && publication.file !== 'undefined' && publication.file !== 'null' &&
            publication.file.trim() !== '') {
            <div class="publication-image" style="position:relative;">
                <img [src]="url + 'get-image-pub/' + publication.file" alt="Imagen de publicaci√≥n"
                    (error)="handlePublicationImageError($event)">
                <button type="button" class="image-expand-btn"
                    (click)="toggleImagePreview(url + 'get-image-pub/' + publication.file)"
                    [attr.aria-label]="expandedImage === (url + 'get-image-pub/' + publication.file) ? 'Cerrar vista ampliada' : 'Ampliar imagen'">
                    @if (expandedImage !== (url + 'get-image-pub/' + publication.file)) {<span>üîç</span>}
                    @if (expandedImage === (url + 'get-image-pub/' + publication.file)) {<span>‚úñ</span>}
                </button>
            </div>
            }
        </div>
    </div>
    }

    @if (showDeleteModal) {
    <div class="mymodal-overlay" (click)="closeDeleteModal()">
        <div class="mymodal-content" (click)="$event.stopPropagation()">
            <div class="mymodal-header">
                <span class="mymodal-title">¬øEliminar publicaci√≥n?</span>
                <button class="mymodal-close" (click)="closeDeleteModal()">‚úñ</button>
            </div>
            <div class="mymodal-body">
                <p>¬øEst√°s seguro de que quieres borrar esta publicaci√≥n? Esta acci√≥n no se puede deshacer.</p>
            </div>
            <div class="mymodal-actions">
                <button class="mymodal-btn mymodal-cancel" (click)="closeDeleteModal()">Cancelar</button>
                <button class="mymodal-btn mymodal-confirm" (click)="confirmDeletePublication()">S√≠, borrar</button>
            </div>
        </div>
    </div>
    }


    @if (expandedImage) {
    <div class="image-preview-overlay">
        <button type="button" class="image-preview-close" (click)="toggleImagePreview(expandedImage)"
            aria-label="Cerrar vista ampliada">‚úñ</button>
        <img [src]="expandedImage" alt="Imagen ampliada" class="image-preview-modal">
    </div>
    }

    @if (publications.length > 0 && !noMore) {
    <div class="col-lg-12 text-center timeline-more-wrap">
        <p>
            <button class="timeline-more" (click)="viewMore()">Ver m√°s publicaciones</button>
        </p>
    </div>
    }
</div>